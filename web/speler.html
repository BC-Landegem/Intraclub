<style type="text/css">
  .highlighted {
    background-color: #ebebeb;
  }
  #speler-intro {
    display: flex;
    justify-content: space-between;
    color: #666;
    padding-bottom: 25px;
  }
  #speler-naam {
    font-size: 20px;
  }
  #speler-voornaam,
  #huidigeRanking {
    font-size: 30px;
  }

  #wedstrijdenSpeler {
    border-collapse: collapse;
    width: 100%;
    margin: 0 auto;
    table-layout: fixed;
  }

  #wedstrijdenSpeler tr {
    border-bottom: 1px solid #eb0000;
  }
  #wedstrijdenSpeler tr:last-child {
    border-bottom: 0px;
  }

  #wedstrijdenSpeler td {
    padding: 0.75rem;
    vertical-align: top;
    word-wrap: break-word;
  }

  #wedstrijdenSpeler th:first-child,
  #wedstrijdenSpeler td:first-child {
    width: 10%;
  }

  #wedstrijdenSpeler th:nth-child(2),
  #wedstrijdenSpeler td:nth-child(2) {
    width: 25%;
  }

  #wedstrijdenSpeler th:last-child,
  #wedstrijdenSpeler td:last-child {
    width: 65%;
  }

  .match-players {
    text-align: center;
    font-weight: bold;
    background-color: #f5f5f5;
  }
  .sets-column {
    width: 100%;
  }
  .set-details {
    padding: 8px 0;
    border-bottom: 1px solid #ddd;
  }
  .set-details:last-child {
    border-bottom: none;
  }
  .set-header {
    font-weight: bold;
    color: #333;
    margin-bottom: 5px;
    font-size: 14px;
  }
  .set-pairing {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 3px 0;
    flex-wrap: wrap;
  }
  .team-left,
  .team-right {
    flex: 1;
    font-size: 16px;
    min-width: 0;
  }
  .team-left {
    text-align: right;
    padding-right: 10px;
  }
  .team-right {
    text-align: left;
    padding-left: 10px;
  }
  .vs {
    font-weight: bold;
    color: #eb0000;
    padding: 0 10px;
    font-size: 14px;
    flex-shrink: 0;
  }
  .score {
    font-weight: bold;
    color: #333;
    text-align: center;
    margin-top: 3px;
  }
  #wedstrijdenTitel {
    display: none;
    justify-content: center;
    color: #666;
    font-size: 32px;
  }
  #wedstrijdenSpelerDiv {
    display: none;
    overflow-x: auto;
    width: 100%;
  }

  /* Mobile responsive styles */
  @media (max-width: 768px) {
    #wedstrijdenSpeler td {
      padding: 0.5rem;
    }

    .team-left,
    .team-right {
      font-size: 14px;
    }

    .vs {
      font-size: 12px;
      padding: 0 5px;
    }

    .set-header {
      font-size: 12px;
    }
  }

  @media (max-width: 480px) {
    .set-pairing {
      flex-direction: column;
      align-items: stretch;
      gap: 5px;
    }

    .team-left,
    .team-right {
      text-align: center;
      padding: 0;
      font-size: 13px;
    }

    .vs {
      text-align: center;
      padding: 5px 0;
    }

    #wedstrijdenSpeler td {
      padding: 0.4rem;
    }

    .match-players div {
      font-size: 14px;
      line-height: 1.4;
    }
  }
</style>
<div id="spelerInformatie" style="margin: 5px 5px;">
  <div id="speler-intro">
    <div class="speler-hero-naam">
      <div id="speler-voornaam"></div>
      <div id="speler-naam"></div>
    </div>
    <div>
      <div id="huidigeRanking"></div>
      <div id="hoogsteRankingOoit"></div>
    </div>
  </div>

  <div id="chartsRow" style="display: flex; flex-wrap: wrap; justify-content: space-evenly;">
    <div id="chartAanwezig" style="max-width: 300px;"></div>
    <div id="chartSets" style="max-width: 300px;"></div>
    <div id="chartPunten" style="max-width: 300px;"></div>

  </div>
  <div id="rankingHistory"></div>
  <div id="wedstrijdenTitel">Wedstrijden</div>
  <div id="wedstrijdenSpelerDiv">
    <table id="wedstrijdenSpeler">
      <tbody>
        <tr>
          <th>#</th>
          <th>Spelers</th>
          <th>Sets</th>
        </tr>
      </tbody>
    </table>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
  const urlParams = new URLSearchParams(window.location.search);
  const spelerId = urlParams.get("spelerId");
  var request = new XMLHttpRequest();
  request.open("GET", "/intra-app/api/index.php/players/" + spelerId, true);

  request.onload = function () {
    if (this.status >= 200 && this.status < 400) {
      // Success!
      var data = JSON.parse(this.response);
      if (data.id) {
        document.getElementById("speler-voornaam").innerText = data.firstName;
        document.getElementById("speler-naam").innerText = data.name;
        document.title = "BC Landegem - " + data.firstName + " " + data.name;
        const [huidigeRanking] = data.statistics.rankingHistory.slice(-1);
        if (huidigeRanking) {
          document.getElementById("huidigeRanking").innerText = "Ranking: " + huidigeRanking.rank;
          const hoogsteRankschikking = Math.min.apply(
            Math,
            data.statistics.rankingHistory.map(function (o) {
              return o.rank;
            })
          );
          const laatsteSpeeldagMetHoogsteRankschikking = data.statistics.rankingHistory
            .slice()
            .reverse()
            .find((rankHis) => rankHis.rank === hoogsteRankschikking);
          document.getElementById("hoogsteRankingOoit").innerText =
            "Beste : " +
            hoogsteRankschikking +
            " (op speeldag " +
            laatsteSpeeldagMetHoogsteRankschikking.number +
            ")";
        }

        const aanwezigPercentage = berekenPercentage(
          data.statistics.rounds.present,
          data.statistics.rankingHistory.length
        );
        const winstPuntenPercentage = berekenPercentage(
          data.statistics.points.won,
          data.statistics.points.total
        );
        const winstsetPercentage = berekenPercentage(
          data.statistics.sets.won,
          data.statistics.sets.total
        );

        var chartAanwezig = basicChart;
        chartAanwezig.series = [aanwezigPercentage];
        chartAanwezig.labels = ["Aanwezig"];
        new ApexCharts(document.querySelector("#chartAanwezig"), chartAanwezig).render();

        var chartSets = basicChart;
        chartSets.series = [winstsetPercentage];
        chartSets.labels = ["Sets"];
        new ApexCharts(document.querySelector("#chartSets"), chartSets).render();

        var chartPunten = basicChart;
        chartPunten.series = [winstPuntenPercentage];
        chartPunten.labels = ["Punten"];
        new ApexCharts(document.querySelector("#chartPunten"), chartPunten).render();

        rankingHistory.series[0].data = data.statistics.rankingHistory.map((rh) => rh.rank);
        rankingHistory.xaxis.categories = data.statistics.rankingHistory.map((rh) =>
          rh.number.toString()
        );
        new ApexCharts(document.querySelector("#rankingHistory"), rankingHistory).render();
        document.getElementById("wedstrijdenTitel").style.display = "flex";
        document.getElementById("wedstrijdenSpelerDiv").style.display = "flex";
        genereerMatchTabel(
          document.querySelector("#wedstrijdenSpeler"),
          data.matches,
          data.statistics.rankingHistory,
          data.id
        );
      } else {
        // We reached our target server, but it returned an error
        document.getElementById("spelerInformatie").innerText = "Woeps, er ging iets mis!";
      }
    }
  };

  request.onerror = function () {
    // There was a connection error of some sort
    document.getElementById("spelerInformatie").innerText =
      "De tussenstand kon niet geladen worden";
  };
  request.send();
  var basicChart = {
    colors: ["#eb0000"],
    chart: {
      type: "radialBar",
      offsetY: -20,
      sparkline: {
        enabled: true,
      },
    },
    plotOptions: {
      radialBar: {
        startAngle: -90,
        endAngle: 90,
        track: {
          background: "#e7e7e7",
          strokeWidth: "97%",
          margin: 5, // margin is in pixels
          dropShadow: {
            enabled: true,
            top: 2,
            left: 0,
            opacity: 1,
            blur: 2,
          },
        },
        dataLabels: {
          name: {
            offsetY: -25,
            show: true,
          },
          value: {
            offsetY: -16,
            fontSize: "22px",
          },
        },
      },
    },
    grid: {
      padding: {
        top: -10,
        bottom: 20,
      },
    },
    fill: {
      type: "gradient",
      gradient: {
        shade: "dark",
        type: "horizontal",
        gradientToColors: ["yellow"],
        stops: [0, 100],
      },
    },
  };
  var rankingHistory = {
    series: [
      {
        name: "Ranking",
        data: [],
      },
    ],
    colors: ["#eb0000"],
    chart: {
      height: 350,
      type: "line",
      zoom: {
        enabled: false,
      },
      toolbar: {
        show: false,
      },
    },
    markers: {
      size: 4,
    },
    dataLabels: {
      enabled: false,
    },
    stroke: {
      curve: "straight",
    },
    title: {
      text: "Klassement geschiedenis",
      align: "left",
      style: {
        fontSize: "16px",
        color: "#666",
      },
    },
    grid: {
      row: {
        colors: ["#f3f3f3", "transparent"], // takes an array which will be repeated on columns
        opacity: 0.5,
      },
    },
    xaxis: {
      categories: [],
      title: {
        text: "Speeldag",
        style: {
          fontSize: "16px",
          color: "#666",
        },
      },
    },
    yaxis: {
      reversed: true,
      labels: {
        formatter: function (val, index) {
          return val.toFixed(0);
        },
      },
    },
    tooltip: {
      x: {
        show: true,
        formatter: function (val) {
          return "Speeldag " + val;
        },
      },
    },
  };

  function genereerMatchTabel(table, data, rankingHistory, playerId) {
    for (let element of data) {
      let row = table.insertRow();

      // Speeldag number cell
      insertCell(row, element.round.number, "speeldag");

      // Get player references
      const player1 = element.firstPlayer;
      const player2 = element.secondPlayer;
      const player3 = element.thirdPlayer;
      const player4 = element.fourthPlayer;

      // Players cell - show all 4 players with highlighting for current player
      const playersHtml = `
        <div style="text-align: left;">
          ${bouwVolledigeNaam(player1, playerId)}<br>
          ${bouwVolledigeNaam(player2, playerId)}<br>
          ${bouwVolledigeNaam(player3, playerId)}<br>
          ${bouwVolledigeNaam(player4, playerId)}
        </div>      
      `;
      insertCell(row, playersHtml, "match-players");

      // Sets details cell
      let setsHtml = "";

      // Set 1: P1+P2 vs P3+P4
      setsHtml += `
        <div class="set-details">
          <div class="set-header">Set 1</div>
          <div class="set-pairing">
            <div class="team-left">${bouwSpelerNaam(player1, playerId)} & ${bouwSpelerNaam(player2, playerId)}</div>
            <div class="vs">vs</div>
            <div class="team-right">${bouwSpelerNaam(player3, playerId)} & ${bouwSpelerNaam(player4, playerId)}</div>
          </div>
          <div class="score">${bouwSet(element.firstSet)}</div>
        </div>
      `;

      // Set 2: P1+P3 vs P2+P4
      setsHtml += `
        <div class="set-details">
          <div class="set-header">Set 2</div>
          <div class="set-pairing">
            <div class="team-left">${bouwSpelerNaam(player1, playerId)} & ${bouwSpelerNaam(player3, playerId)}</div>
            <div class="vs">vs</div>
            <div class="team-right">${bouwSpelerNaam(player2, playerId)} & ${bouwSpelerNaam(player4, playerId)}</div>
          </div>
          <div class="score">${bouwSet(element.secondSet)}</div>
        </div>
      `;

      // Set 3: P1+P4 vs P2+P3
      setsHtml += `
        <div class="set-details">
          <div class="set-header">Set 3</div>
          <div class="set-pairing">
            <div class="team-left">${bouwSpelerNaam(player1, playerId)} & ${bouwSpelerNaam(player4, playerId)}</div>
            <div class="vs">vs</div>
            <div class="team-right">${bouwSpelerNaam(player2, playerId)} & ${bouwSpelerNaam(player3, playerId)}</div>
          </div>
          <div class="score">${bouwSet(element.thirdSet)}</div>
        </div>
      `;

      insertCell(row, setsHtml, "sets-column");
    }
  }

  function bouwSpelerNaam(player, huidigePlayerId) {
    if (player.id == huidigePlayerId) {
      return `<span class="highlighted" style="padding: 2px 4px; border-radius: 3px;">${player.firstName} ${player.name}</span>`;
    }
    return `${player.firstName} ${player.name}`;
  }
  function bouwVolledigeNaam(player, huidigePlayerId) {
    var spelerLink = "<div";
    if (player.id == huidigePlayerId) {
      spelerLink = spelerLink + " class='highlighted'";
    }
    spelerLink =
      spelerLink +
      "><a href='/intraclub/speler?spelerId=" +
      player.id +
      "'>" +
      player.firstName +
      " " +
      player.name +
      "</a></div>";
    return spelerLink;
  }
  function bouwSet(set) {
    return set.home + "-" + set.away;
  }
  function insertCell(row, cellText, className) {
    let cell = row.insertCell();
    cell.className = className;
    cell.innerHTML = cellText;
  }
  function berekenPercentage(amount, total) {
    if (isNaN(amount) || isNaN(total)) {
      return 0;
    } else if (total == 0) {
      return 0;
    } else {
      return Math.round((amount / total) * 100);
    }
  }
</script>
